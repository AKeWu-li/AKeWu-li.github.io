<!DOCTYPE html><html class="hide-aside" lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>SpatiaLLM | 啊可恶的博客</title><meta name="author" content="啊可恶"><meta name="copyright" content="啊可恶"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content=".vscode文件夹虽然 launch.json 文件位于 .vscode 文件夹里，但 VS Code 调试器默认的工作目录 (Current Working Directory, CWD)是你的项目根目录（也就是你用 VS Code 打开的那个最外层文件夹），而不是 .vscode 文件夹..."><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "SpatiaLLM",
  "url": "https://blog.liiz.top/2026/01/29/SpatiaLLM/",
  "image": "https://liiz-blog.oss-cn-shenzhen.aliyuncs.com/avatar.jpg",
  "datePublished": "2026-01-29T07:19:45.000Z",
  "dateModified": "2026-01-29T07:23:05.158Z",
  "author": [
    {
      "@type": "Person",
      "name": "啊可恶",
      "url": "https://blog.liiz.top"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://blog.liiz.top/2026/01/29/SpatiaLLM/index.html"><link rel="preconnect" href="//cdnjs.cloudflare.com"><link rel="stylesheet" href="/css/index.css?v=5.5.3"><link rel="stylesheet" href="https://lib.baomitu.com/font-awesome/6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/node-snackbar/0.1.16/snackbar.min.css" media="print" onload='this.media="all"'><script>(() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!true && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"pagination":{"enable":false,"hitsPerPage":8},"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":true,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'medium_zoom',
  Snackbar: {"chs_to_cht":"已切换为繁体中文","cht_to_chs":"已切换为简体中文","day_to_night":"已切换为深色模式","night_to_day":"已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdnjs.cloudflare.com/ajax/libs/egjs-infinitegrid/4.12.0/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"SpatiaLLM",isHighlightShrink:!1,isToc:!0,pageType:"post"}</script><link rel="stylesheet" href="https://npm.elemecdn.com/lxgw-wenkai-screen-webfont@1.7.0/lxgwwenkaigbscreen.css"><link rel="stylesheet" href="https://unpkg.com/@firacode/cdn@latest/fired_code.css"><link rel="stylesheet" href="/css/welcome.css"><style>#footer,#footer-wrap{background:0 0!important;background-attachment:scroll!important;box-shadow:none!important}#footer-wrap::before,#footer::before{background:0 0!important;content:''!important}.article-sort-item::before{content:'\f35a'!important;font-family:'Font Awesome 6 Free'!important;font-weight:900!important;background:0 0!important;border:none!important;color:#000!important;font-size:20px!important;width:auto!important;height:auto!important;left:-40px!important;top:2px!important;transition:all .3s ease-in-out}.article-sort-title::before{content:'\f358'!important;font-family:'Font Awesome 6 Free'!important;font-weight:900!important;background:0 0!important;border:none!important;color:#000!important;font-size:24px!important;width:auto!important;height:auto!important;left:-10px!important;top:20px!important;transition:all .3s ease-in-out}.article-sort-item:hover::before,.article-sort-title:hover::before{transform:rotate(360deg);color:#00000f!important}.snackbar-container{background:#dfe9f3!important;background-color:#dfe9f3!important;border-radius:8px!important;display:flex!important;justify-content:center!important;align-items:center!important;bottom:0!important;left:20px!important;transform:none!important;transition:opacity .5s ease-in-out!important;min-width:180px!important;border:none!important}.snackbar-container[style*="opacity: 0"]{opacity:0!important;pointer-events:none!important}.snackbar-container p{font-family:'LXGW WenKai Screen',sans-serif!important;font-size:20px!important;font-weight:700!important;color:#00c2b5!important;margin:0!important;padding:6px 10px!important;text-align:center!important;line-height:1.5!important}.snackbar-container p::before{content:'\f058';font-family:'Font Awesome 6 Free'!important;font-weight:900!important;margin-right:8px!important;font-size:22px!important}@media screen and (max-width:768px){.snackbar-container{left:50%!important;transform:translateX(-50%)!important}}#page-header:not(.full_page){background:0 0!important;background-image:none!important;height:300px!important;box-shadow:none!important;border:none!important;margin-bottom:0!important}#page-header:not(.full_page)::before{background:0 0!important;box-shadow:none!important}#page-header:not(.full_page) #site-subtitle,#page-header:not(.full_page) #site-title,#page-header:not(.full_page) .page-title,#page-header:not(.full_page) .post-meta{color:#4c4948!important;text-shadow:none!important}#page-header:not(.full_page) #nav{z-index:9999!important;background:0 0!important;box-shadow:none!important}#page-header:not(.full_page) #nav #blog_name a,#page-header:not(.full_page) #nav #site-name{color:#333!important;text-shadow:none!important;font-weight:700!important}#page-header:not(.full_page) #nav .menus_item a{color:#333!important;text-shadow:none!important;font-weight:700!important}#page-header:not(.full_page) #nav #search-button{color:#333!important}#page-header:not(.full_page) #nav .toggle-menu{color:#333!important}#page-header:not(.full_page) #nav .menus_item a:hover{color:#00c2b5!important}body.home #nav #blog_name .site-name,body.home #nav #site-name{color:#fff!important;text-shadow:2px 2px 4px rgba(0,0,0,.6)!important}body.home #nav .menus_item .site-page,body.home #nav .menus_item i{color:#fff!important;text-shadow:1px 1px 2px rgba(0,0,0,.5)!important}body.home #nav #search-button{color:#fff!important;text-shadow:1px 1px 2px rgba(0,0,0,.5)!important}body:not(.home) #nav #blog_name .site-name,body:not(.home) #nav #site-name{color:#333!important;text-shadow:none!important;font-weight:900!important}body:not(.home) #nav .menus_item .site-page,body:not(.home) #nav .menus_item i{color:#333!important;text-shadow:none!important;font-weight:700!important}body:not(.home) #nav #search-button{color:#333!important}body:not(.home) #page-header .page-title{color:#333!important;text-shadow:none!important}body:not(.home) #post-info .post-title{color:#000!important;text-shadow:none!important;font-weight:700!important}body:not(.home) #post-info #post-meta,body:not(.home) #post-info .post-meta-separator,body:not(.home) #post-info i{color:#555!important;text-shadow:none!important}#nav #search-button:hover,#nav .site-name:hover,#nav .site-page:hover{color:#00c2b5!important}#page~#aside-content{display:none!important}.layout #page{float:none!important;margin:0 auto!important;width:90%!important;max-width:1200px!important;padding:40px!important}#nav #blog-info{display:none!important}#nav{justify-content:flex-end!important}#pagination.pagination-post .cover{background:linear-gradient(to top,#dfe9f3 0,#dfe9f3 100%)!important;opacity:1!important}#pagination.pagination-post .cover::after,#pagination.pagination-post .cover::before,#pagination.pagination-post .next-post>a::after,#pagination.pagination-post .next-post>a::before,#pagination.pagination-post .prev-post>a::after,#pagination.pagination-post .prev-post>a::before{background:0 0!important;background-image:none!important;display:none!important;opacity:0!important;content:none!important}#pagination.pagination-post .info-item-1,#pagination.pagination-post .info-item-2{color:#00c2b5!important;text-shadow:none!important;font-weight:700!important}#pagination.pagination-post:hover .info-item-1,#pagination.pagination-post:hover .info-item-2{color:#000!important}</style><script src="https://npm.elemecdn.com/typed.js@2.0.12/lib/typed.min.js"></script><script src="/js/custom.js"></script><meta name="generator" content="Hexo 5.4.2"></head><body><div class="bg-animation" id="web_bg" style="background:linear-gradient(to top,#dfe9f3 0,#fff 100%)"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://liiz-blog.oss-cn-shenzhen.aliyuncs.com/avatar.jpg" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">13</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">14</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">3</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background:linear-gradient(to top,#dfe9f3 0,#fff 100%)"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">啊可恶的博客</span></a><a class="nav-page-title" href="/"><span class="site-name">SpatiaLLM</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span> 返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">SpatiaLLM</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2026-01-29T07:19:45.000Z" title="发表于 2026-01-29 15:19:45">2026-01-29</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2026-01-29T07:23:05.158Z" title="更新于 2026-01-29 15:23:05">2026-01-29</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/3D-Reconstruction/">3D Reconstruction</a></span></div><div class="meta-secondline"></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h2 id="vscode文件夹"><a href="#vscode文件夹" class="headerlink" title=".vscode文件夹"></a>.vscode文件夹</h2><p>虽然 launch.json 文件位于 .vscode 文件夹里，但 VS Code 调试器默认的工作目录 (Current Working Directory, CWD)是你的项目根目录（也就是你用 VS Code 打开的那个最外层文件夹），而不是 .vscode 文件夹</p><h2 id="Step-Over、Step-Into、Step-Out"><a href="#Step-Over、Step-Into、Step-Out" class="headerlink" title="Step Over、Step Into、Step Out"></a>Step Over、Step Into、Step Out</h2><p>Step Over (单步跳过):调试主函数时，调试器不会带你进入中间调用的函数内部,当你确信被调用函数是没问题的时候用<br><strong>Step Into (单步调试 / 进入)：</strong> 遇到被调用函数会进入函数内部<br>Step Out (单步跳出)：点击后，它会立即执行完当前被调用函数剩余的所有代码，然后直接跳回到主函数中调用它的地方的下一行</p><h2 id="Prompt-长什么样"><a href="#Prompt-长什么样" class="headerlink" title="Prompt 长什么样"></a>Prompt 长什么样</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">prompt = <span class="string">&#x27;&lt;|point_start|&gt;&lt;|point_pad|&gt;&lt;|point_end|&gt;Detect walls, doors, windows, boxes. The reference code is as followed: @dataclass\nclass Wall:\n    ax: int\n    ay: int\n    az: int\n    bx: int\n    by: int\n    bz: int\n    height: int\n    thickness: int\n\n@dataclass\nclass Door:\n    wall_id: str\n    position_x: int\n    position_y: int\n    position_z: int\n    width: int\n    height: int\n\n@dataclass\nclass Window:\n    wall_id: str\n    position_x: int\n    position_y: int\n    position_z: int\n    width: int\n    height: int\n\n@dataclass\nclass Bbox:\n    class: str\n    position_x: int\n    position_y: int\n    position_z: int\n    angle_z: int\n    scale_x: int\n    scale_y: int\n    scale_z: int&#x27;</span></span><br></pre></td></tr></table></figure><p><strong>视觉感知层 (&lt;|point_start|&gt;…)：</strong> 之前的 preprocess_point_cloud 生成的那个 Tensor（点云特征）会通过 Cross-Attention 或者 Embedding 注入到这里。模型读到这里时，它“看”到了房间的 3D 结构<br><strong>任务指令层 (Detect walls…)：</strong> 这是一个标准的 NLP 指令，告诉模型现在的任务是“检测”，而不是“描述房间风格”或者“数椅子”<br><strong>语法约束层（The reference code is as followed）：</strong> 利用了 LLM 强大的代码补全能力。Input: class Wall: … (定义)；Output: wall_1 = Wall(ax=10, ay=20…) (实例化/调用)</p><h2 id="关于generate-layout的输出"><a href="#关于generate-layout的输出" class="headerlink" title="关于generate_layout的输出"></a>关于generate_layout的输出</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">layout_str = <span class="string">&#x27;wall_0=Wall(2,2,2,132,2,2,136,0)\nwall_1=Wall(2,2,2,2,200,2,136,0)\nwall_2=Wall(132,2,2,132,170,2,136,0)\nwall_3=Wall(78,170,2,132,170,2,136,0)\nwall_4=Wall(78,170,2,78,200,2,136,0)\nwall_5=Wall(2,200,2,78,200,2,136,0)\ndoor_0=Door(wall_5,44,200,44,39,104)\nwindow_0=Window(wall_0,67,2,68,116,83)\nbbox_0=Bbox(curtain,67,6,68,639,207,12,133)\nbbox_1=Bbox(dressing_table,113,29,25,480,85,60,73)\nbbox_2=Bbox(bed,89,88,19,480,121,138,53)\nbbox_3=Bbox(painting,132,91,59,480,83,6,50)\nbbox_4=Bbox(nightstand,124,136,12,480,30,27,30)\nbbox_5=Bbox(wardrobe,105,159,51,320,87,35,155)&#x27;</span></span><br></pre></td></tr></table></figure><p>最后的输出layout（其实就是layout_str的转换）里面包含doors、windows、bboxes类</p><h3 id="具体的例子"><a href="#具体的例子" class="headerlink" title="具体的例子"></a>具体的例子</h3><p>Wall(id=5, ax=0.05, ay=5.0, az=0.05, bx=1.95, by=5.0, bz=0.05, height=2.72, thickness=0.0, entity_label=’wall’)<br>Door(id=0, wall_id=5, position_x=1.1, position_y=5.0, position_z=1.1, width=0.78, height=2.08, entity_label=’door’)</p><h4 id="Wall"><a href="#Wall" class="headerlink" title="Wall"></a>Wall</h4><p>ax,ay,az为起点，bx,by,bz为终点，可以看到连成的一条线是平行与x轴的一条直线。然后平行于Z轴延申height（即2.72米），垂直与这个墙面向左向右延申共thickness（这里是0米），这样就准确描述好了这个墙</p><h4 id="Door"><a href="#Door" class="headerlink" title="Door"></a>Door</h4><p>wall_id表示与门属于哪个墙<br>position_x,y,z表示其中心点位置<br>根据width向左右延申，height向上下延申，类似嵌入到墙里面，因此可以确定方向，厚度也与wall一致</p><h4 id="如下图所示"><a href="#如下图所示" class="headerlink" title="如下图所示"></a>如下图所示</h4><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Z (高度)</span><br><span class="line">^</span><br><span class="line">|       ---------------------  &lt;- 墙顶 (2.77)</span><br><span class="line">|       |                   |</span><br><span class="line">|       |                   |</span><br><span class="line">|       |      _______      |  &lt;- 门顶 (2.14)</span><br><span class="line">|       |     |       |     |</span><br><span class="line">|       |     |       |     |</span><br><span class="line">|       |     |  Door |     |</span><br><span class="line">|       |     |_______|     |  &lt;- 门底 (0.06)</span><br><span class="line">|       -------=======-------  &lt;- 地板 (0.05)</span><br><span class="line">-------------------------------------&gt; X (水平位置)</span><br><span class="line">      0.05   0.71     1.49   1.95</span><br><span class="line">      (墙始)  (门始)   (门终) (墙终)</span><br></pre></td></tr></table></figure><h2 id="项目架构"><a href="#项目架构" class="headerlink" title="项目架构"></a>项目架构</h2><h3 id="感知层（Sonata编码器）"><a href="#感知层（Sonata编码器）" class="headerlink" title="感知层（Sonata编码器）"></a>感知层（Sonata编码器）</h3><h4 id="对应-spatiallm-model-spatiallm-qwen-py-60行附近"><a href="#对应-spatiallm-model-spatiallm-qwen-py-60行附近" class="headerlink" title="对应 spatiallm/model/spatiallm_qwen.py 60行附近"></a>对应 spatiallm/model/spatiallm_qwen.py 60行附近</h4><p>为了让 LLM 看懂 3D 点云，必须先用一个 Encoder 把 N 个点的点云变成 K 个特征向量<br>注：inference.py 里的 preprocess_point_cloud 把点云变成了 Grid（网格）格式，这正是为了喂给这个 Encoder</p><h3 id="翻译层（MLP）"><a href="#翻译层（MLP）" class="headerlink" title="翻译层（MLP）"></a>翻译层（MLP）</h3><h4 id="对应-spatiallm-model-spatiallm-qwen-py-83行附近"><a href="#对应-spatiallm-model-spatiallm-qwen-py-83行附近" class="headerlink" title="对应 spatiallm/model/spatiallm_qwen.py 83行附近"></a>对应 spatiallm/model/spatiallm_qwen.py 83行附近</h4><p>把 3D 特征向量“翻译”成 LLM 能理解的 Token Embeddings</p><h3 id="大脑层（LLM）"><a href="#大脑层（LLM）" class="headerlink" title="大脑层（LLM）"></a>大脑层（LLM）</h3><p>使用了通用的开源 LLM（如 Qwen2.5 或 Llama），看到特定的 3D 特征后，输出特定的 Python 代码格式</p><p>注：spatiallm/model/spatiallm_qwen.py 248行附近有一个拼接的操作，把文本里原本用来占位的无效向量（Padding）剪掉， 把 Sonata 算出来的 3D 特征向量粘贴进去</p><table><thead><tr><th align="left">阶段</th><th align="left">数据形态</th><th align="left">执行者 (Component)</th><th align="left">核心动作 (Action)</th></tr></thead><tbody><tr><td align="left"><strong>1. 采集 (Input)</strong></td><td align="left"><code>.ply</code> 文件<br><em>(原始 3D 点云)</em></td><td align="left">Python (Open3D)</td><td align="left"><strong>读取与预处理</strong><br>将点云量化并网格化 (Voxelization)</td></tr><tr><td align="left"><strong>2. 编码 (Encode)</strong></td><td align="left"><strong>Tensor 向量序列</strong><br><em>(Visual Embeddings)</em></td><td align="left"><strong>Sonata Encoder</strong></td><td align="left"><strong>特征提取</strong><br>将几十万个离散点压缩成几百个高维特征向量</td></tr><tr><td align="left"><strong>3. 提示 (Prompt)</strong></td><td align="left">文本向量序列<br><em>(Text Embeddings)</em></td><td align="left">Tokenizer</td><td align="left"><strong>指令注入</strong><br>将 “Detect walls…” 文本转为向量</td></tr><tr><td align="left"><strong>4. 融合 (Fusion)</strong></td><td align="left"><strong>混合多模态向量</strong><br><em>(Input Embeddings)</em></td><td align="left"><code>spatiallm_qwen.py</code></td><td align="left"><strong>移花接木 (Concatenation)</strong><br>剪掉 Prompt 中的占位符，填入 3D 特征向量</td></tr><tr><td align="left"><strong>5. 思考 (Reasoning)</strong></td><td align="left">Logits (概率分布)</td><td align="left"><strong>LLM (Qwen)</strong></td><td align="left"><strong>自回归预测 (Next Token Prediction)</strong><br>结合视觉特征与先验知识，逐个预测字符</td></tr><tr><td align="left"><strong>6. 输出 (Decode)</strong></td><td align="left"><strong>文本字符串</strong><br><em>(<code>wall_0=Wall(...)</code>)</em></td><td align="left">Tokenizer</td><td align="left"><strong>解码</strong><br>将预测的 Token ID 变回人类可读的字符串</td></tr><tr><td align="left"><strong>7. 还原 (Deserialize)</strong></td><td align="left"><strong>Python 对象</strong><br><em>(<code>Wall</code> Instance)</em></td><td align="left"><code>layout.py</code></td><td align="left"><strong>反序列化 (Parsing)</strong><br>解析字符串，实例化为内存中的 3D 对象</td></tr></tbody></table><p>注：Encoder负责把 3D 世界 压缩 成 LLM 能理解的数学特征，而LLM负责把这些数学特征 翻译 成符合 Python 语法的、有逻辑的布局代码，还会预测看不见的地方</p><h2 id="Loss-计算"><a href="#Loss-计算" class="headerlink" title="Loss 计算"></a>Loss 计算</h2><h3 id="对应-spatiallm-tuner-trainer-py-44行附近"><a href="#对应-spatiallm-tuner-trainer-py-44行附近" class="headerlink" title="对应 spatiallm/tuner/trainer.py 44行附近"></a>对应 spatiallm/tuner/trainer.py 44行附近</h3><p>直接使用了父类（以及模型内部 spatiallm_qwen.py）的标准 Loss 计算逻辑：Cross Entropy Loss (交叉熵损失)</p><h2 id="数据流水线（那些杂乱的-ply-文件和-txt-标注，到底经历了什么，才变成了模型能吃的-Tensor？）"><a href="#数据流水线（那些杂乱的-ply-文件和-txt-标注，到底经历了什么，才变成了模型能吃的-Tensor？）" class="headerlink" title="数据流水线（那些杂乱的 .ply 文件和 .txt 标注，到底经历了什么，才变成了模型能吃的 Tensor？）"></a>数据流水线（那些杂乱的 .ply 文件和 .txt 标注，到底经历了什么，才变成了模型能吃的 Tensor？）</h2><h3 id="mm-plugin-py的三大核心职能"><a href="#mm-plugin-py的三大核心职能" class="headerlink" title="mm_plugin.py的三大核心职能"></a>mm_plugin.py的三大核心职能</h3><h3 id="数据增强"><a href="#数据增强" class="headerlink" title="数据增强"></a>数据增强</h3><h4 id="对应42行附近"><a href="#对应42行附近" class="headerlink" title="对应42行附近"></a>对应42行附近</h4><p>颜色干扰： ChromaticJitter (改颜色), RandomColorGrayScale (变黑白)<br>几何干扰： RandomJitter, ElasticDistortion。给点云加噪声、扭曲它。模拟现实中传感器扫描不准的情况<br>随机旋转： self.random_rotation</p><h3 id="格式化：体素化"><a href="#格式化：体素化" class="headerlink" title="格式化：体素化"></a>格式化：体素化</h3><h4 id="对应67行附近"><a href="#对应67行附近" class="headerlink" title="对应67行附近"></a>对应67行附近</h4><p>模型吃不下无限精度的浮点数坐标 (x=1.23456…)。它需要把空间切成格子<br>输出返回 grid_coord (整数索引) 和 coord (原始偏移量)。Sonata Encoder 主要是对这些整数格子进行卷积处理</p><h3 id="文本与点云的“同步旋转”"><a href="#文本与点云的“同步旋转”" class="headerlink" title="文本与点云的“同步旋转”"></a>文本与点云的“同步旋转”</h3><h4 id="对应227行附近"><a href="#对应227行附近" class="headerlink" title="对应227行附近"></a>对应227行附近</h4><p>同步变换：点云怎么转和缩放，Layout 对象就怎么转和缩放</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>输入的是ply文件，也就是原始的3D点云，在mm_plugin.py文件中进行处理，比如数据增强（训练时增加了干扰）、体素化（把空间分成一个个格子，把点云的信息变成格子的信息）；随后在spatiallm_qwen.py文件中，使用Sonata进行编码，把点云变成特征向量；然后把对模型的指令和输出的模板也变成特征向量，并把点云信息转换的特征向量和这些拼接起来（用的字符串分割），形成完整的prompt，输入到LLM中。<br>LLM对看到的信息进行处理（理解），对看不到的信息做出预测，生成python代码（即inference中的layout），生成scene0000_00.txt文件，内容比如：<br>Wall(id=5, ax=0.05, ay=5.0, az=0.05, bx=1.95, by=5.0, bz=0.05, height=2.72, thickness=0.0, entity_label=’wall’)<br>Door(id=0, wall_id=5, position_x=1.1, position_y=5.0, position_z=1.1, width=0.78, height=2.08, entity_label=’door’)<br>最后进行对LLM的输出进行后处理，进行可视化：加载点云ply文件，然后把LLM的输出layout转化成Rerun能理解的格式，可以在Rerun上渲染出来</p></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://blog.liiz.top">啊可恶</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://blog.liiz.top/2026/01/29/SpatiaLLM/">https://blog.liiz.top/2026/01/29/SpatiaLLM/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://blog.liiz.top" target="_blank">啊可恶的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/3DGS/">3DGS</a><a class="post-meta__tags" href="/tags/LLM/">LLM</a></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2026/01/29/SplaTAM/" title="SplaTAM"><div class="cover" style="background:var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">SplaTAM</div></div><div class="info-2"><div class="info-item-1">流程简化3DGS只使用了视图无关性颜色，并强制高斯是各向同性的。这意味着每个高斯仅由8个值参数化：3个为其RGB颜色，3个为其中心位置，1个为其半径，1个为其不透明度 可微渲染给定一组3D高斯和相机位姿，首先将所有高斯从前到后排序。 然后，通过将每个高斯的二维投影按顺序在像素空间进行alpha组合，可以有效地渲染RGB图像 SLAM系统 初始化 对于第一帧，对于每个像素，我们添加一个新的高斯，其颜色为该像素的颜色，中心在该像素深度的未投影位置，不透明度为0.5，投影到二维图像上的半径等于一像素半径，用深度除以焦距得到 相机追踪 相机参数初始化 $$ Et+1 = Et + (Et - Et-1) $$ 基于梯度的优化迭代更新相机位姿，通过差分渲染RGB，深度和剪影图，并更新相机参数，以最小化以下损失，同时保持高斯参数固定 只使用我们渲染的可见性剪影来应用从地图的优化部分渲染的像素的损失，该剪影捕捉了地图的认知不确定性。这对于跟踪新的相机姿态非常重要，因为通常新的帧包含新的信息，而这些信息在我们的地图中尚未被捕获或很好地优化。如果一个像素没有真值深度，L1损失也为0 致...</div></div></div></a><a class="pagination-related" href="/2026/01/14/%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F%E6%95%99%E7%A8%8B/" title="VS Code Remote SSH + SSH ProxyJump 实现内网穿透"><div class="cover" style="background:var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">VS Code Remote SSH + SSH ProxyJump 实现内网穿透</div></div><div class="info-2"><div class="info-item-1">最近闲着没事干，刚好实验室给我们配了一个新电脑，实验室也有一台服务器，但是只有连上实验室的网络才能连上服务器，我们实验室又不在学校这边，因此连服务器很不方便。听同学说可以内网穿透什么的，遂尝试下。需要什么：云服务器、实验室电脑、实验室服务器、宿舍电脑效果如何：让宿舍电脑通过实验室电脑连上实验室的服务器，在宿舍也能使用上实验室的服务器 首先是github搜索下载frp，实验室电脑和云服务器都要下载，一个作为客户端一个作为服务端 云服务器配置：建立中转站，打通外部流量入口添加防火墙规则以aliyun为例，在网络与安全组中的防火墙规则，添加入方向规则，访问来源填0.0.0.0/0，端口填2222 注1：有的端口不一定行，我之前开的端口是7000就不行，可能是被实验室的防火墙给拦截了，最好用常用些的端口，不过也不能用已经被占用的注2：开放端口后试一下：可以在自己电脑的PowerShell中输入：Test-NetConnection 云服务器公网IP地址 -Port 2222注3：可以在云服务器中运行firewall-cmd –list-ports看看有没有成功配置防火墙规则 配置frps...</div></div></div></a></nav></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#vscode%E6%96%87%E4%BB%B6%E5%A4%B9"><span class="toc-number">1.</span> <span class="toc-text">.vscode文件夹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-Over%E3%80%81Step-Into%E3%80%81Step-Out"><span class="toc-number">2.</span> <span class="toc-text">Step Over、Step Into、Step Out</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Prompt-%E9%95%BF%E4%BB%80%E4%B9%88%E6%A0%B7"><span class="toc-number">3.</span> <span class="toc-text">Prompt 长什么样</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E4%BA%8Egenerate-layout%E7%9A%84%E8%BE%93%E5%87%BA"><span class="toc-number">4.</span> <span class="toc-text">关于generate_layout的输出</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E7%9A%84%E4%BE%8B%E5%AD%90"><span class="toc-number">4.1.</span> <span class="toc-text">具体的例子</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Wall"><span class="toc-number">4.1.1.</span> <span class="toc-text">Wall</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Door"><span class="toc-number">4.1.2.</span> <span class="toc-text">Door</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E4%B8%8B%E5%9B%BE%E6%89%80%E7%A4%BA"><span class="toc-number">4.1.3.</span> <span class="toc-text">如下图所示</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E6%9E%B6%E6%9E%84"><span class="toc-number">5.</span> <span class="toc-text">项目架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%84%9F%E7%9F%A5%E5%B1%82%EF%BC%88Sonata%E7%BC%96%E7%A0%81%E5%99%A8%EF%BC%89"><span class="toc-number">5.1.</span> <span class="toc-text">感知层（Sonata编码器）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E5%BA%94-spatiallm-model-spatiallm-qwen-py-60%E8%A1%8C%E9%99%84%E8%BF%91"><span class="toc-number">5.1.1.</span> <span class="toc-text">对应 spatiallm&#x2F;model&#x2F;spatiallm_qwen.py 60行附近</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BF%BB%E8%AF%91%E5%B1%82%EF%BC%88MLP%EF%BC%89"><span class="toc-number">5.2.</span> <span class="toc-text">翻译层（MLP）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E5%BA%94-spatiallm-model-spatiallm-qwen-py-83%E8%A1%8C%E9%99%84%E8%BF%91"><span class="toc-number">5.2.1.</span> <span class="toc-text">对应 spatiallm&#x2F;model&#x2F;spatiallm_qwen.py 83行附近</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%A7%E8%84%91%E5%B1%82%EF%BC%88LLM%EF%BC%89"><span class="toc-number">5.3.</span> <span class="toc-text">大脑层（LLM）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Loss-%E8%AE%A1%E7%AE%97"><span class="toc-number">6.</span> <span class="toc-text">Loss 计算</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E5%BA%94-spatiallm-tuner-trainer-py-44%E8%A1%8C%E9%99%84%E8%BF%91"><span class="toc-number">6.1.</span> <span class="toc-text">对应 spatiallm&#x2F;tuner&#x2F;trainer.py 44行附近</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E6%B5%81%E6%B0%B4%E7%BA%BF%EF%BC%88%E9%82%A3%E4%BA%9B%E6%9D%82%E4%B9%B1%E7%9A%84-ply-%E6%96%87%E4%BB%B6%E5%92%8C-txt-%E6%A0%87%E6%B3%A8%EF%BC%8C%E5%88%B0%E5%BA%95%E7%BB%8F%E5%8E%86%E4%BA%86%E4%BB%80%E4%B9%88%EF%BC%8C%E6%89%8D%E5%8F%98%E6%88%90%E4%BA%86%E6%A8%A1%E5%9E%8B%E8%83%BD%E5%90%83%E7%9A%84-Tensor%EF%BC%9F%EF%BC%89"><span class="toc-number">7.</span> <span class="toc-text">数据流水线（那些杂乱的 .ply 文件和 .txt 标注，到底经历了什么，才变成了模型能吃的 Tensor？）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#mm-plugin-py%E7%9A%84%E4%B8%89%E5%A4%A7%E6%A0%B8%E5%BF%83%E8%81%8C%E8%83%BD"><span class="toc-number">7.1.</span> <span class="toc-text">mm_plugin.py的三大核心职能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%A2%9E%E5%BC%BA"><span class="toc-number">7.2.</span> <span class="toc-text">数据增强</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E5%BA%9442%E8%A1%8C%E9%99%84%E8%BF%91"><span class="toc-number">7.2.1.</span> <span class="toc-text">对应42行附近</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%BC%E5%BC%8F%E5%8C%96%EF%BC%9A%E4%BD%93%E7%B4%A0%E5%8C%96"><span class="toc-number">7.3.</span> <span class="toc-text">格式化：体素化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E5%BA%9467%E8%A1%8C%E9%99%84%E8%BF%91"><span class="toc-number">7.3.1.</span> <span class="toc-text">对应67行附近</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E6%9C%AC%E4%B8%8E%E7%82%B9%E4%BA%91%E7%9A%84%E2%80%9C%E5%90%8C%E6%AD%A5%E6%97%8B%E8%BD%AC%E2%80%9D"><span class="toc-number">7.4.</span> <span class="toc-text">文本与点云的“同步旋转”</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E5%BA%94227%E8%A1%8C%E9%99%84%E8%BF%91"><span class="toc-number">7.4.1.</span> <span class="toc-text">对应227行附近</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">8.</span> <span class="toc-text">总结</span></a></li></ol></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"></div></div><div id="footer-animal"><div class="animal-wall"></div><img class="animal" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.meimolihan.eu.org/hexo/img/color.avif" alt="动物" onerror='this.onerror=null,this.src="/img/404.jpg"'></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button><button id="go-down" type="button" title="直达底部" onclick="btf.scrollToDest(document.body.scrollHeight,500)"><i class="fas fa-arrow-down"></i></button></div></div><div><script src="/js/utils.js?v=5.5.3"></script><script src="/js/main.js?v=5.5.3"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.1.0/medium-zoom.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/instant.page/5.2.0/instantpage.min.js" type="module"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/19.1.3/lazyload.iife.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/node-snackbar/0.1.16/snackbar.min.js"></script><div class="js-pjax"></div><script src="https://liiz-blog.oss-cn-shenzhen.aliyuncs.com/js/live2d.min.js"></script><script>var timer=setInterval(function(){"undefined"!=typeof OML2D&&(clearInterval(timer),OML2D.loadOml2d({dockedPosition:"left",menus:{disable:!0},models:[{path:"https://liiz-blog.oss-cn-shenzhen.aliyuncs.com/live2d_models/yileina/LSS.model3.json",position:[0,150],scale:.4,stageStyle:{height:500}}]}))},50)</script><script src="https://cdnjs.cloudflare.com/ajax/libs/pjax/0.2.8/pjax.min.js" defer></script><script>document.addEventListener('DOMContentLoaded', () => {
  const pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

  window.pjax = new Pjax({
    elements: 'a:not([target="_blank"])',
    selectors: pjaxSelectors,
    cacheBust: false,
    analytics: false,
    scrollRestoration: false
  })

  const triggerPjaxFn = (val) => {
    if (!val) return
    Object.values(val).forEach(fn => {
      try {
        fn()
      } catch (err) {
        console.debug('Pjax callback failed:', err)
      }
    })
  }

  document.addEventListener('pjax:send', () => {
    // removeEventListener
    btf.removeGlobalFnEvent('pjaxSendOnce')
    btf.removeGlobalFnEvent('themeChange')

    // reset readmode
    const $bodyClassList = document.body.classList
    if ($bodyClassList.contains('read-mode')) $bodyClassList.remove('read-mode')

    triggerPjaxFn(window.globalFn.pjaxSend)
  })

  document.addEventListener('pjax:complete', () => {
    btf.removeGlobalFnEvent('pjaxCompleteOnce')
    document.querySelectorAll('script[data-pjax]').forEach(item => {
      const newScript = document.createElement('script')
      const content = item.text || item.textContent || item.innerHTML || ""
      Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
      newScript.appendChild(document.createTextNode(content))
      item.parentNode.replaceChild(newScript, item)
    })

    triggerPjaxFn(window.globalFn.pjaxComplete)
  })

  document.addEventListener('pjax:error', e => {
    if (e.request.status === 404) {
      false
        ? pjax.loadUrl('/404.html')
        : window.location.href = e.request.responseURL
    }
  })
})</script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><i class="fas fa-spinner fa-pulse" id="loading-status" hidden></i><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span> 数据加载中</span></div><div class="local-search-input"><input placeholder="搜索文章" type="text"></div><hr><div id="local-search-results"></div><div class="ais-Pagination" id="local-search-pagination" style="display:none"><ul class="ais-Pagination-list"></ul></div><div id="local-search-stats"></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=5.5.3"></script></div></div></body></html>